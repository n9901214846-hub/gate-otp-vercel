<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Guard Code Screen</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial;margin:0;background:#0b1220;color:#fff;display:flex;min-height:100vh;align-items:center;justify-content:center}
    .card{width:min(560px,92vw);background:#121b2f;border:1px solid rgba(255,255,255,.10);border-radius:18px;padding:22px;box-shadow:0 18px 60px rgba(0,0,0,.35)}
    h1{margin:0 0 10px;font-size:20px;opacity:.95}
    .code{font-size:74px;letter-spacing:10px;font-weight:900;text-align:center;margin:18px 0}
    .row{display:flex;gap:12px;flex-wrap:wrap;justify-content:space-between}
    .pill{flex:1;min-width:200px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px}
    .label{font-size:12px;opacity:.7}
    .val{font-size:16px;margin-top:6px}
    button{width:100%;margin-top:14px;border:0;border-radius:14px;padding:12px;font-weight:900;background:#c1121f;color:#fff;cursor:pointer}
    button:active{transform:scale(.99)}
    .small{margin-top:10px;font-size:12px;opacity:.65}
    .err{margin-top:10px;padding:10px;border-radius:12px;border:1px solid rgba(239,68,68,.35);background:rgba(239,68,68,.08);display:none}
  </style>
</head>
<body>
  <div class="card">
    <h1>üõ°Ô∏è Gate Code (Guard)</h1>
    <div class="code" id="code">------</div>

    <div class="row">
      <div class="pill">
        <div class="label">Next change in</div>
        <div class="val" id="timer">--:--</div>
      </div>
      <div class="pill">
        <div class="label">Server time</div>
        <div class="val" id="stime">--</div>
      </div>
    </div>

    <button id="refresh">Refresh now</button>
    <div id="err" class="err"></div>
    <div class="small">Backend: <span id="baseTxt"></span></div>
  </div>

<script>
  const BASE = "https://gate-otp-vercel.vercel.app";
  document.getElementById("baseTxt").textContent = BASE;

  const errBox = document.getElementById("err");
  function showErr(msg){
    errBox.style.display = "block";
    errBox.textContent = msg;
  }
  function clearErr(){
    errBox.style.display = "none";
    errBox.textContent = "";
  }

  async function fetchCode(){
    clearErr();
    const r = await fetch(`${BASE}/api/gateCode`, { cache: "no-store" });
    const j = await r.json();

    if(!j.ok) throw new Error(j.error || "Failed to fetch code");

    document.getElementById("code").textContent = j.code;
    document.getElementById("stime").textContent = j.serverTime;
    startCountdown(j.remainingSeconds);
  }

  let interval = null;
  function startCountdown(sec){
    clearInterval(interval);
    function render(){
      const m = String(Math.floor(sec/60)).padStart(2,"0");
      const s = String(sec%60).padStart(2,"0");
      document.getElementById("timer").textContent = `${m}:${s}`;
      if(sec <= 0){
        fetchCode().catch(e => showErr(e.message));
        return;
      }
      sec--;
    }
    render();
    interval = setInterval(render, 1000);
  }

  document.getElementById("refresh").addEventListener("click", ()=>{
    fetchCode().catch(e => showErr(e.message));
  });

  // ‚úÖ Auto-load on page open
  fetchCode().catch(e => showErr(e.message));
</script>
</body>
</html>
